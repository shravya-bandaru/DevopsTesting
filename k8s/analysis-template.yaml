apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: hello-world-success-rate
  namespace: hello-world
spec:
  metrics:
    - name: success-rate
      interval: 60s
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus:9090
          query: |
            sum(rate(http_requests_total{job="hello-world",status=~"2.."}[5m])) /
            sum(rate(http_requests_total{job="hello-world"}[5m]))
      successCriteria: "{{ result | float | gt 0.95 }}"
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisRun
metadata:
  name: hello-world-canary-analysis
  namespace: hello-world
spec:
  template:
    name: hello-world-success-rate
  args:
    metrics:
      - name: success-rate
        value: "0.95"
  ttlSecondsAfterFinished: 3600
