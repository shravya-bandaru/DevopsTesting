# CI/CD Pipeline workflow for automated testing and deployment to Azure App Service
# This pipeline implements the PwC DevOps diagram with multi-stage builds and progressive deployment strategies
name: CI/CD Pipeline - Azure App Service with Blue-Green & Canary Deployments

# When this workflow triggers:
# - Pull requests to main/develop branches → Run fast tests (DEV + QA)
# - Pushes to main → Full pipeline (build, test, deploy to staging, canary, then production)
# - Pushes to testbranch → Build and test stages only
# - Manual trigger → Allows on-demand workflow execution
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

# Global environment variables available to all jobs
env:
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}           # Use git commit SHA as unique image tag
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===== SETUP STAGE =====
  # Common setup: checkout, authenticate, get credentials
  setup:
    name: Setup & Authenticate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      acr-username: ${{ steps.acr-creds.outputs.ACR_USERNAME }}
      acr-password: ${{ steps.acr-creds.outputs.ACR_PASSWORD }}
      image-name: ${{ steps.image-name.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image-name
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Log in to Azure Container Registry
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials
        id: acr-creds
        run: |
          az acr update -n ${{ secrets.ACR_NAME }} --admin-enabled true
          ACR_USERNAME=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query username)
          ACR_PASSWORD=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query passwords[0].value)
          echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_OUTPUT

  # ===== BUILD IRON IMAGE =====
  build-iron:
    name: Build Iron Image (Development)
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials and login
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query username)
          ACR_PASSWORD=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query passwords[0].value)
          echo $ACR_PASSWORD | docker login ${{ secrets.ACR_NAME }}.azurecr.io -u $ACR_USERNAME --password-stdin

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Iron Image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: iron
          push: true
          tags: ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:iron-${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== BUILD BRONZE IMAGE =====
  build-bronze:
    name: Build Bronze Image (QA)
    runs-on: ubuntu-latest
    needs: build-iron

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials and login
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query username)
          ACR_PASSWORD=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query passwords[0].value)
          echo $ACR_PASSWORD | docker login ${{ secrets.ACR_NAME }}.azurecr.io -u $ACR_USERNAME --password-stdin

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Bronze Image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: bronze
          push: true
          tags: ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:bronze-${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== BUILD SILVER IMAGE =====
  build-silver:
    name: Build Silver Image (Integration)
    runs-on: ubuntu-latest
    needs: build-bronze

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials and login
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query username)
          ACR_PASSWORD=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query passwords[0].value)
          echo $ACR_PASSWORD | docker login ${{ secrets.ACR_NAME }}.azurecr.io -u $ACR_USERNAME --password-stdin

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Silver Image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: silver
          push: true
          tags: ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:silver-${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== BUILD GOLD IMAGE =====
  build-gold:
    name: Build Gold Image (Staging)
    runs-on: ubuntu-latest
    needs: build-silver

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials and login
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query username)
          ACR_PASSWORD=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query passwords[0].value)
          echo $ACR_PASSWORD | docker login ${{ secrets.ACR_NAME }}.azurecr.io -u $ACR_USERNAME --password-stdin

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Gold Image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: gold
          push: true
          tags: |
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:gold-${{ env.IMAGE_TAG }}
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:gold-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== BUILD PLATINUM IMAGE =====
  build-platinum:
    name: Build Platinum Image (Production)
    runs-on: ubuntu-latest
    needs: build-gold

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials and login
        run: |
          ACR_USERNAME=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query username)
          ACR_PASSWORD=$(az acr credential show -n ${{ secrets.ACR_NAME }} -o tsv --query passwords[0].value)
          echo $ACR_PASSWORD | docker login ${{ secrets.ACR_NAME }}.azurecr.io -u $ACR_USERNAME --password-stdin

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Platinum Image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: platinum
          push: true
          tags: |
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:platinum-${{ env.IMAGE_TAG }}
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:platinum-latest
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_LOWER }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
